<script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chess List</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
</head>

<body>
    <th:block th:replace="~{layout::header}"></th:block>
    <style>
        .chessboard {
            background-image: url("/images/bancotuong.jpg");
            width: 850px;
            height: 850px;
            position: absolute;
        }
    
        .chessnode {
            position: absolute;
            width: 50px;
            height: 50px;
        }
    
        .chessimgnode {
            width: 50px;
            height: 50px;
        }
    </style>
    <div layout:fragment="content" id="app" style="min-height:900px">
        
        <div class="chessboard">
            <div v-for="item in chessNode" class="chessnode"
                    v-on:dragstart="dragStart"
                    v-on:dragend="dragEnd"
                    :id="item.id" :style="{ display: item.visible, top: item.top + 'px', left: item.left + 'px' }">
                    <img :src="'/images' + item.src" class="chessimgnode" />
            </div>
        </div>
    </div>
    <!--Chat-->
    <div layout:fragment="content" class="container">
        <div class="row p-1">
            <div class="col-1">User</div>
            <div class="col-5"><input type="text" id="userInput" th:value="${session.playername}" readonly="readonly" /></div>
        </div>
        <div class="row p-1">
            <div class="col-1">Message</div>
            <div class="col-5"><input type="text" class="w-100" id="messageInput" /></div>
        </div>
        <div class="row p-1">
            <div class="col-6 text-end">
                <input type="button" id="sendButton" value="Send Message" />
            </div>
        </div>
        <div class="row p-1">
            <div class="col-6">
                <hr />
            </div>
        </div>
        <div class="row p-1">
            <div class="col-6">
                <ul id="messagesList"></ul>
            </div>
        </div>
    </div>
    <th:block th:replace="~{layout::footer}"></th:block>
</body>
</html>
<script th:src="@{/js/chat.js}"></script>
<script th:inline="javascript">
   
    var matrix = [];
    var currentPlayer;
    var app = new Vue({
        el: "#app",
        data: {
            chessNode: [],
            msg: "test message",
            top:0,
            left:0
        },
        methods: {
            getChessNode() {
                axios({
                    method: 'GET',
                    url: '/api/getChessBoard',
                    responseType: 'Json'
                }).then((response) =>  {
                    this.chessNode = response.data.chessNodeList;
                    this.matrix = response.data.matrix; // Gán dữ liệu ma trận từ API
                    this.currentPlayer = "do";
                    console.log(this.matrix);
                    console.log(this.chessNode);
                }).catch((error) => {
                    console.error('Error fetching chess board data:', error);
                });
            },
            checkIndex(top, left){
                var obj = {};
                
                for (var i = 0; i < this.matrix.length;i++){
                    for(var j=0;j < this.matrix[i].length;j++){
                        if (Math.abs(this.matrix[i][j].top - top) <20 && Math.abs(this.matrix[i][j].left - left) < 20){
                            obj.i = i;
                            obj.j = j;
                            return obj;
                        }
                    }
                }
                return null;
            },
            dragStart(event){
                console.log("Bắt đầu");
                var id = event.currentTarget.id;
                this.top = event.clientY;
                this.left = event.clientX;
            },
            dragEnd(event){
                
                var clientXStart =  event.currentTarget.offsetLeft;
                var clientYStart =  event.currentTarget.offsetTop;
               
                var clientX = event.clientX - this.left + event.currentTarget.offsetLeft;
                var clientY = event.clientY - this.top + event.currentTarget.offsetTop;
                clientX = Math.abs(clientX);
                clientY = Math.abs(clientY);
                var objEnd = this.checkIndex(clientY, clientX);
                var objStart = this.checkIndex(clientYStart, clientXStart);
               
                if (objEnd == null){
                   return;
                }
                console.log("Player now is "+this.currentPlayer);
                
                if (this.currentPlayer === "do") {
                    if(event.currentTarget.id.indexOf("do") >= 0)
                    {
                        //Quân Mã
                        if (event.currentTarget.id.indexOf("ma") >=0 ){
                            if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 2) ||
                            (Math.abs(objStart.i - objEnd.i) == 2 && Math.abs(objStart.j - objEnd.j) == 1))
                            {
                                
                                if (Math.abs(objStart.i - objEnd.i) == 2){
                                    //Xung quanh tiến lên không bị chặn
                                    if (objEnd.i > objStart.i  && this.matrix[objStart.i + 1][objStart.j].id != " " )
                                    {
                                        
                                        return;
                                    }
                                    //Xung quanh lui về không bị chặn
                                    if (objEnd.i < objStart.i && this.matrix[objStart.i - 1][objStart.j].id != " " )
                                    {
                                        
                                        return;
                                    }
                                }
                                if (Math.abs(objStart.j - objEnd.j) == 2) {
                                    //Xung quanh ngang không bị chặn
                                    if (objEnd.j > objStart.j && this.matrix[objStart.i][objStart.j + 1].id != " "  )
                                    {
                                        
                                        return;
                                    }
                                    if (objEnd.j < objStart.j && this.matrix[objStart.i][objStart.j - 1].id != " " )
                                    {
                                        
                                        return;
                                    }
                                }
                                var tempchess = "do";
                                if(event.currentTarget.id.indexOf(tempchess) < 0)
                                {
                                    tempchess= "den";
                                }
                                if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >0)
                                {
                                    return;
                                }
    
                            }  
                            else if((Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 2) 
                                || (Math.abs(objStart.i - objEnd.i) != 2 && Math.abs(objStart.j - objEnd.j) == 1) )
                            {
                                return;
                            } 
                            else if((Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) > 0) 
                            || (Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) == 0))   
                            {
                                return;
                            }                      
                        }
                       
                        //Quân tướng
                        if (event.currentTarget.id.indexOf("chu") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }
                            if( objEnd.i <= 2 && objEnd.j > 2 && objEnd.j < 6)
                            {
                                
                                if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) == 1))
                                {
                                        console.log("KetQua:"+Math.abs(objStart.j - objEnd.j));
                                        if (Math.abs(objStart.i - objEnd.i) == 1){
                                           
                                            if (objEnd.i > objStart.i  && this.matrix[objStart.i + 1][objStart.j].id != " " &&
                                            this.matrix[objStart.i + 1][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                
                                                return;
                                            }
                                            if (objEnd.i < objStart.i && this.matrix[objStart.i - 1][objStart.j].id != " " &&
                                            this.matrix[objStart.i - 1][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                
                                                return;
                                            }
                                            
                                        }
                                        if(Math.abs(objStart.j - objEnd.j) == 1) 
                                        {
                                        
                                            if (objEnd.j > objStart.j && this.matrix[objStart.i][objStart.j + 1].id != " "  &&
                                            this.matrix[objStart.i][objStart.j + 1].id.indexOf(tempchess) > 0 )
                                            {
                                            
                                                return;
                                            }
                                            if (objEnd.j < objStart.j && this.matrix[objStart.i][objStart.j - 1].id != " " &&
                                            this.matrix[objStart.i][objStart.j - 1].id.indexOf(tempchess) > 0 )
                                            {
                                                
                                                return;
                                            }
                                            
                                        }
                                        
                                    
                                    

                                }
                                else if((Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) != 1))
                                {
                                    return;
                                }
                                //Cấm đi chéo
                                else if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) != 0) ||
                                (Math.abs(objStart.i - objEnd.i) != 0 && Math.abs(objStart.j - objEnd.j) == 1))
                                {
                                    return;
                                }
                                if((Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) != 1))
                                {
                                    return;
                                }
                            }
                            else
                            {
                                return;
                            }
                            
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >0)
                            {
                                return;
                            }
                                    
                        }   

                        //Quân xe
                        if (event.currentTarget.id.indexOf("xe") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }
                            
                            if((Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) == 0) ||  
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) > 0) )
                            {
                                if (Math.abs(objStart.i - objEnd.i) > 0){

                                    if(objEnd.i > objStart.i)
                                    {
                                        for(var s = objStart.i+1; s < objEnd.i; s++)
                                        {
                                            console.log("quan co hien tai la:"+s);
                                            if ( this.matrix[s][objStart.j].id != " " &&
                                            this.matrix[s][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                            
                                        }
                                    }
                                    if(objEnd.i < objStart.i)
                                    {
                                        for(var s = objStart.i-1; s >= objEnd.i; s--)
                                        {
                                            console.log("quan co hien tai la:"+s);
                                            if ( this.matrix[s][objStart.j].id != " " &&
                                            this.matrix[s][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                            
                                        }
                                    }
                                   
                                    
                                }
                                if(Math.abs(objStart.j - objEnd.j) > 0) 
                                {
                                    if(objEnd.j > objStart.j)
                                    {
                                        for(var s = objStart.j+1; s < objEnd.j; s++)
                                        {
                                            if (objEnd.j > objStart.j && this.matrix[objStart.i][s].id != " "  &&
                                            this.matrix[objStart.i][s].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                            
                                        }
                                    }
                                    else if(objEnd.j < objStart.j)
                                    {
                                        for(var s = objStart.j - 1; s >= objEnd.j; s--)
                                        {
                                            if ( this.matrix[objStart.i][s].id != " " &&
                                            this.matrix[objStart.i][s].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                        }
                                    }
                                    
                                    
                                }
                            }
                            else if((Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) != 0) ||  
                            (Math.abs(objStart.i - objEnd.i) != 0 && Math.abs(objStart.j - objEnd.j) > 0) )
                            {
                                return;
                            }
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) > 0)
                            {
                                return;
                            }
                            
                        }    

                        //Quân tượng
                        if (event.currentTarget.id.indexOf("tuong") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }
                            if( objEnd.i < 5 && objEnd.j >= 0 && objEnd.j < 9)
                            {
                                if((Math.abs(objStart.i - objEnd.i) == 2 && Math.abs(objStart.j - objEnd.j) == 2))
                                {
                                   
                                        if(objStart.i == 0)
                                        {
                                            //Xung quanh ngang không bị chặn
                                            if (objEnd.j > objStart.j && this.matrix[objStart.i + 1][objStart.j + 1].id != " "  )
                                            {
                                                console.log("banPick1");
                                                return;
                                            }
                                            if (objEnd.j < objStart.j && this.matrix[objStart.i + 1][objStart.j - 1].id != " "  )
                                            {
                                                console.log("banPick12");
                                                return;
                                            }
                                        }
                                        if(objStart.i >0)
                                        {
                                            if(objStart.j > 0 && objStart.j < 8)
                                            {
                                                if (objEnd.j > objStart.j && this.matrix[objStart.i + 1][objStart.j + 1].id != " "  )
                                                {
                                                    console.log("banPick1");
                                                    return;
                                                }
                                                if (objEnd.j < objStart.j && this.matrix[objStart.i + 1][objStart.j - 1].id != " "  )
                                                {
                                                    console.log("banPick12");
                                                    return;
                                                }
                                                
                                               
                                                if (objEnd.i < objStart.i && this.matrix[objStart.i - 1][objStart.j - 1].id != " " )
                                                {
                                                    console.log("banPick2");
                                                    return;
                                                }
                                                else if (objEnd.i > objStart.i && this.matrix[objStart.i - 1][objStart.j + 1].id != " " )
                                                {
                                                    console.log("banPick3");
                                                    return;
                                                }
                                               
                                                
                                            }
                                            else
                                            {
                                                if(objStart.j == 0)
                                                {
                                                    if(objStart.j < objEnd.j && objStart.i > objEnd.i)
                                                    {
                                                        if(this.matrix[objStart.i - 1][objStart.j + 1].id != " " )
                                                        {
                                                            console.log("banPick4");
                                                            return;
                                                        }
                                                        
                                                    }
                                                    else if(objStart.j < objEnd.j && objStart.i < objEnd.i)
                                                    {
                                                        if(this.matrix[objStart.i + 1][objStart.j + 1].id != " " )
                                                        {
                                                            console.log("banPick4");
                                                            return;
                                                        }
                                                        
                                                    }
                                                    
                                                }
                                                if(objStart.j == 8)
                                                {
                                                    if(objStart.j > objEnd.j && objStart.i > objEnd.i)
                                                    {
                                                        if(this.matrix[objStart.i - 1][objStart.j - 1].id != " " )
                                                        {
                                                            console.log("banPick4");
                                                            return;
                                                        }
                                                        
                                                    }
                                                    else if(objStart.j > objEnd.j && objStart.i < objEnd.i)
                                                    {
                                                        if(this.matrix[objStart.i + 1][objStart.j - 1].id != " " )
                                                        {
                                                            console.log("banPick4");
                                                            return;
                                                        }
                                                        
                                                    }
                                                }
                                            }
                                            
                                        }
                                       
                                }
                                else if((Math.abs(objStart.i - objEnd.i) != 2 && Math.abs(objStart.j - objEnd.j) != 2) || 
                                (Math.abs(objStart.i - objEnd.i) == 2 && Math.abs(objStart.j - objEnd.j) != 2) || 
                                (Math.abs(objStart.i - objEnd.i) != 2 && Math.abs(objStart.j - objEnd.j) == 2)
                                )
                                {
                                    return;
                                }
                            }
                            else
                            {
                                return;
                            }
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) > 0)
                            {
                                return;
                            }
                        }

                        //Quân sĩ
                        if (event.currentTarget.id.indexOf("si") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }

                            if( objEnd.i <= 2 && objEnd.j > 2 && objEnd.j < 6)
                            {
                                
                                if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 1))
                                {
                                    if(objStart.i == 0 && objStart.j == 3) 
                                    {
                                        if (objEnd.i > objStart.i  && this.matrix[objStart.i + 1][objStart.j + 1].id != " " &&
                                        this.matrix[objStart.i + 1][objStart.j + 1].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }  
                                    else if(objStart.i == 0 && objStart.j == 5)
                                    {
                                        if (objEnd.i > objStart.i && this.matrix[objStart.i + 1][objStart.j - 1].id != " "  &&
                                        this.matrix[objStart.i + 1][objStart.j + 1].id.indexOf(tempchess) > 0 )
                                        {
                                        
                                            return;
                                        }
                                    }
                                    
                                    //Giữa cung
                                    if(objStart.i == 1)
                                    {
                                        if ( this.matrix[objEnd.i][objEnd.j].id != " " &&
                                        this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }
                                    if(objStart.i == 2 && objStart.j == 3)
                                    {
                                        if ( this.matrix[objStart.i - 1][objStart.j + 1].id != " " &&
                                        this.matrix[objStart.i - 1][objStart.j + 1].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }
                                    else if(objStart.i == 2 && objStart.j == 5)
                                    {
                                        if (this.matrix[objStart.i - 1][objStart.j - 1].id != " " &&
                                        this.matrix[objStart.i - 1][objStart.j - 1].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }
                                    
                                       

                                            
                                       
                                    

                                }
                                else if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) != 1) ||
                                (Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 1) ||
                                (Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) != 1))
                                {
                                    return;
                                }
                                
                            }
                            else
                            {
                                return;
                            }
                            
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >0)
                            {
                                return;
                            }
                        }

                        //Quân Pháo
                        if (event.currentTarget.id.indexOf("phao") >= 0) 
                        {
                            var tempchess = "do";
                            if (event.currentTarget.id.indexOf(tempchess) < 0) {
                                tempchess = "den";
                            }
                            
                            let obstacleCount = 0;
                            // Điều kiện di chuyển ngang/ dọc
                            if ((Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) > 0)) 
                            {
                                if (Math.abs(objStart.i - objEnd.i) == 1) 
                                {
                                    console.log(Math.abs(objStart.i - objEnd.i));
                                    if(this.matrix[objEnd.i][objEnd.j].id != " ")
                                    {
                                        if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                        {
                                            return;
                                        } 
                                        else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                        {
                                            return;
                                        }
                                    }
                                    
                                }
                                if (Math.abs(objStart.j - objEnd.j) == 1) 
                                {
                                    if(this.matrix[objEnd.i][objEnd.j].id != " ")
                                    {
                                        if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                        {
                                            return;
                                        } 
                                        else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                        {
                                            return;
                                        }
                                    }
                                }
                        
                                if (Math.abs(objStart.i - objEnd.i) > 0) 
                                {
                                    if (objEnd.i > objStart.i) 
                                    {
                                        for (var s = objStart.i + 1; s < objEnd.i; s++) 
                                        {
                                            console.log("s1: "+s);
                                            // Có vật cản
                                            if (this.matrix[s][objStart.j].id != " ") 
                                            {
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        obstacleCount++;
                                                    }
                                                } 
                                                else 
                                                {
                                                    return;
                                                }
                                            }
                                            
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.i);
                                            console.log(s === objEnd.i);
                                            if(s === objEnd.i)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                    } 
                                    else if (objEnd.i < objStart.i) 
                                    {
                                        for (var s = objStart.i - 1; s > objEnd.i; s--) 
                                        {
                                            console.log("s2: "+s);
                                            
                                            // Có vật cản
                                            if (this.matrix[s][objStart.j].id != " ") 
                                            {
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        obstacleCount++;
                                                    }
                                                } 
                                                else {
                                                    return;
                                                }
                                            }
                                            
                                        
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.i);
                                            console.log(s === objEnd.i);
                                            
                                            if(s === objEnd.i)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                    }
                                }
                                if (Math.abs(objStart.j - objEnd.j) > 0) 
                                {
                                    if (objEnd.j > objStart.j) 
                                    {
                                        for (var s = objStart.j + 1; s < objEnd.j; s++) 
                                        {
                                            console.log("s3: "+s);
                                            // Có vật cản
                                            if (this.matrix[objStart.i][s].id != " ") 
                                            {
                                                console.log("stun success");
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        
                                                        obstacleCount++;
                                                        console.log("Sau bi chan: "+obstacleCount);
                                                    }
                                                } 
                                                else 
                                                {
                                                    return;
                                                }
                                            }
                                            
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.j);
                                            
                                            console.log(s+1 == objEnd.j);
                                            if(s == objEnd.j)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                        
                                    } 
                                    else if (objEnd.j < objStart.j) 
                                    {
                                        for (var s = objStart.j - 1; s > objEnd.j; s--) 
                                        {
                                            // Có vật cản
                                            if (this.matrix[objStart.i][s].id != " ") 
                                            {
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        obstacleCount++;
                                                    }
                                                } else 
                                                {
                                                    return;
                                                }
                                            }
                                            
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.j);
                                            console.log(s === objEnd.j);
                                            console.log(s-1 == objEnd.j);
                                            if(s == objEnd.j)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                        
                                        
                                    }
                                }
                                console.log("SL Vat can: "+obstacleCount);
                                //Nếu vật cản > 1 quân
                                if(obstacleCount > 1)
                                {
                                    
                                    return;
                                }
                            } 
                            else if ((Math.abs(objStart.i - objEnd.i) > 0 || Math.abs(objStart.j - objEnd.j) > 0)) 
                            {
                                return;
                            }
                        
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) {
                                return;
                            }
                        }

                        //Quân tốt
                        if (event.currentTarget.id.indexOf("tot") >= 0) 
                        {
                            var tempchess = "do";
                            if (event.currentTarget.id.indexOf(tempchess) < 0) {
                                tempchess = "den";
                            }

                            if( objEnd.i < 5 && objEnd.j >= 0 && objEnd.j < 9)
                            {
                                //Chưa vượt sông
                                if(Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 0)
                                {
                                    if(objStart.i < objEnd.i)
                                    {
                                        if(this.matrix[objStart.i+1][objStart.j].id != " ")
                                        {
                                            if (this.matrix[objStart.i+1][objStart.j].id.indexOf(tempchess) >= 0) 
                                            {
                                                return;
                                            } 
                                           
                                        }
                                        
                                    }
                                    else if(objEnd.i < objStart.i)
                                    {
                                        return;
                                    }
                                }
                                else if(Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) != 0
                                || Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0
                                || Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) != 0)
                                {
                                    return;
                                }
                            }
                            else if( objEnd.i > 4 && objEnd.i <= 9 && objEnd.j >= 0 && objEnd.j < 9)
                            {
                                if(objStart.i === 4)
                                {
                                    if(this.matrix[objStart.i+1][objStart.j].id != " ")
                                        {
                                            if (this.matrix[objStart.i+1][objStart.j].id.indexOf(tempchess) >= 0) 
                                            {
                                                return;
                                            } 
                                            else if (this.matrix[objStart.i+1][objStart.j].id.indexOf(tempchess) < 0) 
                                            {
                                                //Chưa vượt
                                                return;
                                            } 
                                        }
                                }
                                else
                                {
                                    if(Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 0 
                                    || Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) == 1)
                                    {
                                        if(objStart.i < objEnd.i)
                                        {
                                            if(this.matrix[objStart.i+1][objStart.j].id != " ")
                                            {
                                                if (this.matrix[objStart.i+1][objStart.j].id.indexOf(tempchess) >= 0) 
                                                {
                                                    return;
                                                } 
                                            }
    
                                            
                                        }
                                        else if(objStart.i < objEnd.i)
                                        {
                                            //Cấm đi lùi
                                            return;
                                        }
                                        if(objStart.j < objEnd.j)
                                        {
                                            if(this.matrix[objStart.i][objStart.j+1].id != " ")
                                            {
                                                if (this.matrix[objStart.i][objStart.j+1].id.indexOf(tempchess) >= 0) 
                                                {
                                                    return;
                                                } 
                                            }
                                        }
                                        if(objStart.j > objEnd.j)
                                        {
                                            if(this.matrix[objStart.i][objStart.j-1].id != " ")
                                            {
                                                if (this.matrix[objStart.i][objStart.j-1].id.indexOf(tempchess) >= 0) 
                                                {
                                                    return;
                                                } 
                                            }
                                        }
                                    }
                                    else if(Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0 
                                    || Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) || 
                                    Math.abs(objStart.i - objEnd.i) != 0 && Math.abs(objStart.j - objEnd.j) != 0 )
                                    {
                                        return;
                                    }
                                }
                                
                                
                            }
                            else
                            {
                                return;
                            }
                        }
                        

                        
                       

                    }
                    else
                    {
                        return;
                    }
                    
                }
                else if(this.currentPlayer === "den") 
                {
                    if(event.currentTarget.id.indexOf("den") >= 0)
                    {
                        //Quân Mã
                        if (event.currentTarget.id.indexOf("ma") >=0 ){
                            if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 2) ||
                            (Math.abs(objStart.i - objEnd.i) == 2 && Math.abs(objStart.j - objEnd.j) == 1))
                            {
                                
                                if (Math.abs(objStart.i - objEnd.i) == 2){
                                    if (objEnd.i > objStart.i  && this.matrix[objStart.i + 1][objStart.j].id != " " )
                                    {
                                        
                                        return;
                                    }
                                    if (objEnd.i < objStart.i && this.matrix[objStart.i - 1][objStart.j].id != " " )
                                    {
                                        
                                        return;
                                    }
                                }
                                if (Math.abs(objStart.j - objEnd.j) == 2) {
                                    if (objEnd.j > objStart.j && this.matrix[objStart.i][objStart.j + 1].id != " "  )
                                    {
                                        
                                        return;
                                    }
                                    if (objEnd.j < objStart.j && this.matrix[objStart.i][objStart.j - 1].id != " " )
                                    {
                                        
                                        return;
                                    }
                                }
                                var tempchess = "do";
                                if(event.currentTarget.id.indexOf(tempchess) < 0)
                                {
                                    tempchess= "den";
                                }
                                if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >0)
                                {
                                    return;
                                }
    
                            }  
                            else if((Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 2) 
                                || (Math.abs(objStart.i - objEnd.i) != 2 && Math.abs(objStart.j - objEnd.j) == 1) )
                            {
                                return;
                            } 
                            else if((Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) > 0) 
                            || (Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) == 0))   
                            {
                                return;
                            }                                 
                        }
                        
                        //Quân tướng
                        if (event.currentTarget.id.indexOf("chu") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }
                            
                            console.log(objStart.i);
                            if( objEnd.i <= 9 && objEnd.i > 6 &&  objEnd.j > 2 && objEnd.j <6)
                            {
                                
                                if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) == 1))
                                {
                                        console.log("KetQua:"+Math.abs(objStart.j - objEnd.j));
                                        if (Math.abs(objStart.i - objEnd.i) == 1){
                                        
                                            if (objEnd.i > objStart.i  && this.matrix[objStart.i + 1][objStart.j].id != " " &&
                                            this.matrix[objStart.i + 1][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                
                                                return;
                                            }
                                            if (objEnd.i < objStart.i && this.matrix[objStart.i - 1][objStart.j].id != " " &&
                                            this.matrix[objStart.i - 1][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                
                                                return;
                                            }
                                            
                                        }
                                        if(Math.abs(objStart.j - objEnd.j) == 1) 
                                        {
                                        
                                            if (objEnd.j > objStart.j && this.matrix[objStart.i][objStart.j + 1].id != " "  &&
                                            this.matrix[objStart.i][objStart.j + 1].id.indexOf(tempchess) > 0 )
                                            {
                                            
                                                return;
                                            }
                                            if (objEnd.j < objStart.j && this.matrix[objStart.i][objStart.j - 1].id != " " &&
                                            this.matrix[objStart.i][objStart.j - 1].id.indexOf(tempchess) > 0 )
                                            {
                                                
                                                return;
                                            }
                                            
                                        }
                                        
                                    
                                    

                                }
                                else if((Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) != 1))
                                {
                                    return;
                                }
                                //Cấm đi chéo
                                else if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) != 0) ||
                                (Math.abs(objStart.i - objEnd.i) != 0 && Math.abs(objStart.j - objEnd.j) == 1))
                                {
                                    return;
                                }
                                if((Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) != 1))
                                {
                                    return;
                                }
                            }
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >0)
                            {
                                return;
                            }
                        }

                        
                        //Quân xe
                        if (event.currentTarget.id.indexOf("xe") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }
                            
                            if((Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) == 0) ||  
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) > 0) )
                            {
                                if (Math.abs(objStart.i - objEnd.i) > 0){

                                    if(objEnd.i > objStart.i)
                                    {
                                        for(var s = objStart.i+1; s < objEnd.i; s++)
                                        {
                                            console.log("quan co hien tai la1:"+s);
                                            if ( this.matrix[s][objStart.j].id != " " &&
                                            this.matrix[s][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                            
                                        }
                                    }
                                    if(objEnd.i < objStart.i)
                                    {
                                        for(var s = objStart.i-1; s >= objEnd.i; s--)
                                        {
                                            console.log("quan co hien tai la:"+s);
                                            if ( this.matrix[s][objStart.j].id != " " &&
                                            this.matrix[s][objStart.j].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                            
                                        }
                                    }
                                   
                                    
                                }
                                if(Math.abs(objStart.j - objEnd.j) > 0) 
                                {
                                    if(objEnd.j > objStart.j)
                                    {
                                        for(var s = objStart.j+1; s < objEnd.j; s++)
                                        {
                                            if (objEnd.j > objStart.j && this.matrix[objStart.i][s].id != " "  &&
                                            this.matrix[objStart.i][s].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                            
                                        }
                                    }
                                    else if(objEnd.j < objStart.j)
                                    {
                                        for(var s = objStart.j - 1; s >= objEnd.j; s--)
                                        {
                                            if ( this.matrix[objStart.i][s].id != " " &&
                                            this.matrix[objStart.i][s].id.indexOf(tempchess) > 0 )
                                            {
                                                return;
                                            }
                                        }
                                    }
                                    
                                    
                                }
                            }
                            else if((Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) == 0) ||  
                            (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) > 0) )
                            {
                                return;
                            }
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) > 0)
                            {
                                return;
                            }
                            
                        }  
                        
                        //Quân tượng
                        if (event.currentTarget.id.indexOf("tuong") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }
                            if( objEnd.i > 4 && objEnd.i <= 9 && objEnd.j >= 0 && objEnd.j < 9)
                            {
                                if((Math.abs(objStart.i - objEnd.i) == 2 && Math.abs(objStart.j - objEnd.j) == 2))
                                {
                                   
                                        if(objStart.i == 9)
                                        {
                                            //Xung quanh ngang không bị chặn
                                            if (objEnd.j > objStart.j && this.matrix[objStart.i - 1][objStart.j + 1].id != " "  )
                                            {
                                                console.log("banPick1");
                                                return;
                                            }
                                            if (objEnd.j < objStart.j && this.matrix[objStart.i - 1][objStart.j - 1].id != " "  )
                                            {
                                                console.log("banPick12");
                                                return;
                                            }
                                        }
                                        if(objStart.i < 9)
                                        {
                                            if(objStart.j > 0 && objStart.j < 8)
                                            {
                                                if (objEnd.j > objStart.j && this.matrix[objStart.i - 1][objStart.j + 1].id != " "  )
                                                {
                                                    console.log("banPick1");
                                                    return;
                                                }
                                                if (objEnd.j < objStart.j && this.matrix[objStart.i - 1][objStart.j - 1].id != " "  )
                                                {
                                                    console.log("banPick12");
                                                    return;
                                                }
                                                
                                               
                                                if (objEnd.i < objStart.i && this.matrix[objStart.i + 1][objStart.j - 1].id != " " )
                                                {
                                                    console.log("banPick2");
                                                    return;
                                                }
                                                else if (objEnd.i > objStart.i && this.matrix[objStart.i - 1][objStart.j + 1].id != " " )
                                                {
                                                    console.log("banPick3");
                                                    return;
                                                }
                                               
                                                
                                            }
                                            else
                                            {
                                                if(objStart.j == 0)
                                                {
                                                   
                                                        if( objStart.j < objEnd.j && this.matrix[objStart.i - 1][objStart.j + 1].id != " " )
                                                        {
                                                            console.log("banPick4");
                                                            return;
                                                        }
                                                    if(objStart.i < objEnd.i)
                                                    {
                                                        if( objStart.j < objEnd.j && this.matrix[objStart.i + 1][objStart.j - 1].id != " " )
                                                        {
                                                            return;
                                                        }
                                                    }
                                                }
                                                if(objStart.j == 8)
                                                {
                                                    if(objStart.i > objEnd.i)
                                                    {
                                                        if( this.matrix[objStart.i - 1][objStart.j - 1].id != " " )
                                                        {
                                                            console.log("banPick4");
                                                            return;
                                                        }
                                                    }
                                                    if(objStart.i < objEnd.i)
                                                    {
                                                        if( this.matrix[objStart.i + 1][objStart.j - 1].id != " " )
                                                        {
                                                            console.log("banPick45");
                                                            return;
                                                        }
                                                    }
                                                }
                                               
                                            }
                                            
                                        }
                                       
                                }
                                else if((Math.abs(objStart.i - objEnd.i) != 2 && Math.abs(objStart.j - objEnd.j) != 2) || 
                                (Math.abs(objStart.i - objEnd.i) == 2 && Math.abs(objStart.j - objEnd.j) != 2) || 
                                (Math.abs(objStart.i - objEnd.i) != 2 && Math.abs(objStart.j - objEnd.j) == 2)
                                )
                                {
                                    return;
                                }
                            }
                            else
                            {
                                return;
                            }
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) > 0)
                            {
                                return;
                            }
                        }

                        //Quân sĩ
                        if (event.currentTarget.id.indexOf("si") >=0 )
                        {
                            var tempchess = "do";
                            if(event.currentTarget.id.indexOf(tempchess) < 0)
                            {
                                tempchess= "den";
                            }

                            if( objEnd.i <= 9 && objEnd.i > 6 &&  objEnd.j > 2 && objEnd.j <6)
                            {
                                
                                if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 1))
                                {
                                    if (objStart.i == 9 && objStart.j == 3)
                                    {
                                        if (objEnd.i < objStart.i  && this.matrix[objStart.i - 1][objStart.j + 1].id != " " &&
                                        this.matrix[objStart.i - 1][objStart.j + 1].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }  
                                    else if (objStart.i == 9 && objStart.j == 5)
                                    {
                                        if (objEnd.i < objStart.i && this.matrix[objStart.i - 1][objStart.j - 1].id != " "  &&
                                        this.matrix[objStart.i - 1][objStart.j - 1].id.indexOf(tempchess) > 0 )
                                        {
                                        
                                            return;
                                        }
                                    }
                                    
                                    //Giữa cung
                                    if(objStart.i == 8)
                                    {
                                        if ( this.matrix[objEnd.i][objEnd.j].id != " " &&
                                        this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }
                                    if(objStart.i == 7 && objStart.j == 3)
                                    {
                                        if ( this.matrix[objStart.i + 1][objStart.j + 1].id != " " &&
                                        this.matrix[objStart.i + 1][objStart.j + 1].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }
                                    else if(objStart.i == 7 && objStart.j == 5)
                                    {
                                        if (this.matrix[objStart.i + 1][objStart.j - 1].id != " " &&
                                        this.matrix[objStart.i + 1][objStart.j - 1].id.indexOf(tempchess) > 0 )
                                        {
                                            
                                            return;
                                        }
                                    }
                                    
                                    

                                            
                                    
                                    

                                }
                                else if((Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) != 1) ||
                                (Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 1) ||
                                (Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) != 1))
                                {
                                    return;
                                }
                                
                            }
                            else
                            {
                                return;
                            }
                            
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >0)
                            {
                                return;
                            }
                        }

                        //Quân Pháo
                        if (event.currentTarget.id.indexOf("phao") >= 0) 
                        {
                            var tempchess = "do";
                            if (event.currentTarget.id.indexOf(tempchess) < 0) {
                                tempchess = "den";
                            }
                            
                            let obstacleCount = 0;
                            // Điều kiện di chuyển ngang/ dọc
                            if ((Math.abs(objStart.i - objEnd.i) > 0 && Math.abs(objStart.j - objEnd.j) == 0) ||
                                (Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) > 0)) 
                            {
                                if (Math.abs(objStart.i - objEnd.i) == 1) 
                                {
                                    console.log(Math.abs(objStart.i - objEnd.i));
                                    if(this.matrix[objEnd.i][objEnd.j].id != " ")
                                    {
                                        if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                        {
                                            return;
                                        } 
                                        else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                        {
                                            return;
                                        }
                                    }
                                    
                                }
                                if (Math.abs(objStart.j - objEnd.j) == 1) 
                                {
                                    if(this.matrix[objEnd.i][objEnd.j].id != " ")
                                    {
                                        if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                        {
                                            return;
                                        } 
                                        else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                        {
                                            return;
                                        }
                                    }
                                }
                        
                                if (Math.abs(objStart.i - objEnd.i) > 0) 
                                {
                                    if (objEnd.i > objStart.i) 
                                    {
                                        for (var s = objStart.i + 1; s < objEnd.i; s++) 
                                        {
                                            console.log("s1: "+s);
                                            // Có vật cản
                                            if (this.matrix[s][objStart.j].id != " ") 
                                            {
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        obstacleCount++;
                                                    }
                                                } 
                                                else 
                                                {
                                                    return;
                                                }
                                            }
                                            
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.i);
                                            console.log(s === objEnd.i);
                                            if(s === objEnd.i)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                    } 
                                    else if (objEnd.i < objStart.i) 
                                    {
                                        for (var s = objStart.i - 1; s > objEnd.i; s--) 
                                        {
                                            console.log("s2: "+s);
                                            
                                            // Có vật cản
                                            if (this.matrix[s][objStart.j].id != " ") 
                                            {
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        obstacleCount++;
                                                    }
                                                } 
                                                else {
                                                    return;
                                                }
                                            }
                                            
                                        
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.i);
                                            console.log(s === objEnd.i);
                                            
                                            if(s === objEnd.i)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                    }
                                }
                                if (Math.abs(objStart.j - objEnd.j) > 0) 
                                {
                                    if (objEnd.j > objStart.j) 
                                    {
                                        for (var s = objStart.j + 1; s < objEnd.j; s++) 
                                        {
                                            console.log("s3: "+s);
                                            // Có vật cản
                                            if (this.matrix[objStart.i][s].id != " ") 
                                            {
                                                console.log("stun success");
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        
                                                        obstacleCount++;
                                                        console.log("Sau bi chan: "+obstacleCount);
                                                    }
                                                } 
                                                else 
                                                {
                                                    return;
                                                }
                                            }
                                            
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.j);
                                            
                                            console.log(s+1 == objEnd.j);
                                            if(s == objEnd.j)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                        
                                    } 
                                    else if (objEnd.j < objStart.j) 
                                    {
                                        for (var s = objStart.j - 1; s > objEnd.j; s--) 
                                        {
                                            // Có vật cản
                                            if (this.matrix[objStart.i][s].id != " ") 
                                            {
                                                // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        obstacleCount++;
                                                    }
                                                } else 
                                                {
                                                    return;
                                                }
                                            }
                                            
                                        }
                                        if(obstacleCount < 1)
                                        {
                                            console.log("s: "+ s + "objEnd.j: "+objEnd.j);
                                            console.log(s === objEnd.j);
                                            console.log(s-1 == objEnd.j);
                                            if(s == objEnd.j)
                                            {
                                                    // Nếu điểm đến có quân cờ
                                                if (this.matrix[objEnd.i][objEnd.j].id != " ") 
                                                {
                                                    if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) 
                                                    {
                                                        return;
                                                    } 
                                                    else if (this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) < 0) 
                                                    {
                                                        return;
                                                    }
                                                } 
                                                
                                            }
                                        }
                                        
                                        
                                    }
                                }
                                console.log("SL Vat can: "+obstacleCount);
                                //Nếu vật cản > 1 quân
                                if(obstacleCount > 1)
                                {
                                    
                                    return;
                                }
                            } 
                            else if ((Math.abs(objStart.i - objEnd.i) > 0 || Math.abs(objStart.j - objEnd.j) > 0)) 
                            {
                                return;
                            }
                        
                            if (this.matrix[objEnd.i][objEnd.j].id != " " && this.matrix[objEnd.i][objEnd.j].id.indexOf(tempchess) >= 0) {
                                return;
                            }
                        }

                        //Quân tốt
                        if (event.currentTarget.id.indexOf("tot") >= 0) 
                        {
                            var tempchess = "do";
                            if (event.currentTarget.id.indexOf(tempchess) < 0) {
                                tempchess = "den";
                            }

                            if( objEnd.i > 4 && objEnd.i <= 9 && objEnd.j >= 0 && objEnd.j < 9)
                            {
                                //Chưa vượt sông
                                if(Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 0)
                                {
                                    if(objStart.i > objEnd.i)
                                    {
                                        if(this.matrix[objStart.i-1][objStart.j].id != " ")
                                        {
                                            if (this.matrix[objStart.i-1][objStart.j].id.indexOf(tempchess) >= 0) 
                                            {
                                                return;
                                            } 
                                            else if (this.matrix[objStart.i-1][objStart.j].id.indexOf(tempchess) < 0) 
                                            {
                                                //Chưa vượt sông, chưa được ăn
                                                return;
                                            } 
                                        }
                                        
                                    }
                                    else if(objEnd.i > objStart.i)
                                    {
                                        return;
                                    }
                                }
                                else if(Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) != 0
                                || Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0
                                || Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) != 0)
                                {
                                    return;
                                }
                            }
                            else if( objEnd.i < 5 && objEnd.j >= 0 && objEnd.j < 9)
                            {
                                if(objStart.i === 5)
                                {
                                    if(this.matrix[objStart.i-1][objStart.j].id != " ")
                                        {
                                            if (this.matrix[objStart.i-1][objStart.j].id.indexOf(tempchess) >= 0) 
                                            {
                                                return;
                                            } 
                                            else if(this.matrix[objStart.i-1][objStart.j].id.indexOf(tempchess) < 0) 
                                            {
                                                //Chưa vượt
                                                return;
                                            } 
                                        }
                                }
                                else
                                {
                                    if(Math.abs(objStart.i - objEnd.i) == 1 && Math.abs(objStart.j - objEnd.j) == 0 
                                    || Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) == 1)
                                    {
                                        if(objStart.i > objEnd.i)
                                        {
                                            if(this.matrix[objStart.i-1][objStart.j].id != " ")
                                            {
                                                if (this.matrix[objStart.i-1][objStart.j].id.indexOf(tempchess) >= 0) 
                                                {
                                                    return;
                                                } 
                                               
                                            }
    
                                            
                                        }
                                        else if(objStart.i < objEnd.i)
                                        {
                                            //Cấm đi lùi
                                            return;
                                        }
                                        if(objStart.j < objEnd.j)
                                        {
                                            if(this.matrix[objStart.i][objStart.j+1].id != " ")
                                            {
                                                if (this.matrix[objStart.i][objStart.j+1].id.indexOf(tempchess) >= 0) 
                                                {
                                                    return;
                                                } 
                                            }
                                        }
                                        if(objStart.j > objEnd.j)
                                        {
                                            if(this.matrix[objStart.i][objStart.j-1].id != " ")
                                            {
                                                if (this.matrix[objStart.i][objStart.j-1].id.indexOf(tempchess) >= 0) 
                                                {
                                                    return;
                                                } 
                                            }
                                        }
                                    }
                                    else if(Math.abs(objStart.i - objEnd.i) != 1 && Math.abs(objStart.j - objEnd.j) == 0 
                                    || Math.abs(objStart.i - objEnd.i) == 0 && Math.abs(objStart.j - objEnd.j) || 
                                    Math.abs(objStart.i - objEnd.i) != 0 && Math.abs(objStart.j - objEnd.j) != 0 )
                                    {
                                        return;
                                    }
                                }
                                
                                
                            }
                            else
                            {
                                return;
                            }
                        }

                        
                        
 
                    }
                    else
                    {
                        return;
                    }


                }
                else {
                    
                    console.log("It's not your turn!");
                }
                
                var room = window.location.pathname.split('/').pop();
                console.log("Phòng"+room);
                var objPara = {};
                objPara.id = event.currentTarget.id;
                objPara.starti = objStart.i;
                objPara.startj = objStart.j;
                objPara.endi = objEnd.i;
                objPara.endj = objEnd.j;
                objPara.rooms = room;
                if(event.currentTarget.id.indexOf("do") >= 0)
                {
                    objPara.player = "do";
                }
                else if( event.currentTarget.id.indexOf("den") >= 0)
                {
                    objPara.player = "den";
                }
                var objParaList = [];
                var objRemove = {};
                objParaList.push(objPara);
                console.log("Vua dac cau location:"+ objEnd.i + "-" +objEnd.j +"Vua dac cau id:" + this.matrix[objEnd.i][objEnd.j].id);
                if (this.matrix[objEnd.i][objEnd.j].id != " ") {
                    //document.getElementById(matrix[objEnd.i][objEnd.j].id).style.display = "none";           
                    objRemove.id = this.matrix[objEnd.i][objEnd.j].id;
                    if(objPara.id === objRemove.id)
                    { 
                        return;
                    }
                    objParaList.push(objRemove);
                }
                            
                //Lưu di chuyển
                axios.post('/api/set-move-chess',
                    JSON.stringify(objParaList),
                    {
                        headers: {
                            'Content-type': 'application/json',
                        }
                    }).then(response => {
                        console.log('Ok');
                    });
                    
                
                /*
                var node = document.getElementById(event.currentTarget.id);
                node.style.top = matrix[objEnd.i][objEnd.j].top + 'px';
                node.style.left = matrix[objEnd.i][objEnd.j].left + 'px';
                matrix[objEnd.i][objEnd.j].id = matrix[objStart.i][objStart.j].id;
                matrix[objStart.i][objStart.j].id = "";
                */

                
            }
            
        },
        // Thay thế mã nguồn SignalR bên .net thực hiện websocket
        mounted: function () {
            var self = this;
            //var currentPlayer = 'do';
            this.getChessNode();
            // Tạo kết nối SockJS và Stomp
            var socket = new SockJS('http://localhost:8080/websocket');
            var stompClient = Stomp.over(socket);
            
            var room = window.location.pathname.split('/').pop();
            var isReloading = false;

            if (window.performance) {
                console.info("window.performance works fine on this browser");
            }
              console.info(performance.navigation.type);
            if (performance.navigation.type == performance.navigation.TYPE_RELOAD) {
                console.info( "This page is reloaded" );
                axios.post('/api/reload-board-all',room
                    ).then(response => {
                        console.log('OkSent');
                });
            }
            else{
                console.info( "This page is delete" );
                window.addEventListener('unload', function () {
                        // Đang thoát trang
                        // Thực hiện các hành động khi trang được thoát
                        axios.post('/api/reload-board',room
                        ).then(response => {
                            console.log('OkSent');
                        });
                   
                });
            }
            window.addEventListener('popstate', function (event) {
                if (event.state && event.state.backButtonPressed) {
                    // Người dùng đã nhấn nút "Back"
                    axios.post('/api/reload-board', room)
                        .then(response => {
                            console.log('OkSent');
                        });
                    // Thêm code xử lý khi người dùng thoát khỏi trang qua nút back ở đây
                }
            });

            
            //thoát trang
            document.getElementById("home").onclick = function(event) {
                axios.post('/api/reload-board',room
                    ).then(response => {
                        console.log('OkSent');
                    });
              };
      

            stompClient.connect({}, function (frame) {
                console.log('WebSocket connection opened.');
                // Đăng ký để lắng nghe tin nhắn từ topic "/topic/chessMove"
                stompClient.subscribe('/topic/chessMove/'+room, function (message) {
                    var objList = JSON.parse(message.body);
                    console.log(objList);
                   
                    // Xử lý tin nhắn "ChessMove"
                    
                        var node = document.getElementById(objList[0].id);
                       
                        node.style.top = self.matrix[objList[0].endi][objList[0].endj].top + 'px';
                        node.style.left = self.matrix[objList[0].endi][objList[0].endj].left + 'px'; 
        
                        self.matrix[objList[0].endi][objList[0].endj].id = node.id;
                        self.matrix[objList[0].starti][objList[0].startj].id = " ";
                        
                        if (objList.length === 2) {
                            document.getElementById(objList[1].id).style.display = "none";
                            if(objList[1].id.indexOf("chu") >= 0)
                            {
                                if(objList[1].id.indexOf("den") >= 0)
                                {
                                    
                                    alert("Người chiến thắng: Phe đỏ");
                                    location.reload();
                                      
                                }
                                else if(objList[1].id.indexOf("do") >= 0)
                                {
                                    alert("Người chiến thắng: Phe đen");
                                    location.reload();
                                }
                            }
                        }
                        self.currentPlayer = objList[0].player;
                        self.currentPlayer = (self.currentPlayer === 'do') ? 'den' : 'do';
                        console.log("Player change to "+self.currentPlayer)
                        
                });

                stompClient.subscribe('/topic/reloadPage/' + room, function (message) {
                    
                    console.log(message.body);
                    if(message.body === "Reloaded")
                    {
                        location.reload()
                        stompClient.send("/topic/reloadPage/"+room, {}, null);
                    }
                    // Xử lý tin nhắn từ topic khác
                    // ...
            
                });
                
            
                
            });

           

            stompClient.onerror = function (error) {
                console.error("WebSocket error: " + error);
            };
        
            stompClient.onclose = function () {
                console.log("WebSocket connection closed.");
            };
        }
    });
</script>